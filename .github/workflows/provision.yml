name: Provision ACA Environment

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Name of the container app environment'
        required: true
      location:
        description: 'Azure region'
        required: true
      env_code:
        description: 'Three letter environment code'
        required: true
      port_context:
        required: true
        description: Includes the action's run id
        type: string

jobs:
  deploy:
    permissions:
      id-token: write
      contents: write

    runs-on: ubuntu-latest
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      PORT_RUN_ID: ${{ fromJson(inputs.port_context).runId }}
    steps:
      - name: Start provisioning
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Starting provisioning'

      - uses: actions/checkout@v3

      - name: Log checkout
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Repository checked out'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Log jq install
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'jq installed'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Log terraform setup
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Terraform setup complete'

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log Azure login
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Azure authentication complete'


      - name: Terraform Init
        run: terraform -chdir=terraform init

      - name: Log terraform init
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Terraform init complete'

      - name: Terraform Plan
        id: plan
        run: |
          terraform -chdir=terraform plan \
            -var="name=${{ github.event.inputs.environment_name }}" \
            -var="location=${{ github.event.inputs.location }}" \
            -var="env_code=${{ github.event.inputs.env_code }}" \
            -input=false -out=tfplan

      - name: Log terraform plan
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Terraform plan succeeded'

      - name: Terraform Apply
        if: success()
        run: terraform -chdir=terraform apply -input=false -auto-approve tfplan

      - name: Log terraform apply
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Terraform apply complete'

      - name: Capture outputs
        if: success()
        id: tf_output
        run: terraform -chdir=terraform output -json > ../outputs.json

      - name: Log outputs captured
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Terraform outputs captured'

      - name: Generate config file
        if: success()
        run: |
          NAME=$(jq -r '.name.value' ../outputs.json)
          LOCATION=$(jq -r '.location.value' ../outputs.json)
          RG=$(jq -r '.resource_group_name.value' ../outputs.json)
          WORKSPACE=$(jq -r '.workspace_name.value' ../outputs.json)
          printf "name: %s\nlocation: %s\nresource_group_name: %s\nworkspace_name: %s\n" \
            "$NAME" "$LOCATION" "$RG" "$WORKSPACE" > \
            configs/${{ github.event.inputs.environment_name }}.yaml

      - name: Log config generated
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Configuration file generated'

      - name: Commit config file
        if: success()
        run: |
          git config user.email "75343302+getport-io[bot]@users.noreply.github.com"
          git config user.name "getport-io[bot]"
          git add configs/${{ github.event.inputs.environment_name }}.yaml
          git commit -m "Add config for ${{ github.event.inputs.environment_name }}"
          git push origin HEAD:main

      - name: Log config committed
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          logMessage: 'Configuration committed'

      - name: Mark run success
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          status: SUCCESS
          logMessage: 'Provisioning complete'

      - name: Mark run failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          baseUrl: ${{ secrets.PORT_BASE_URL }}
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ env.PORT_RUN_ID }}
          status: FAILURE
          logMessage: 'Provisioning failed'
